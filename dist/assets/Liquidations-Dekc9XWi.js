import{u as A,v as k,c as M,d as L,r as C,j as e,w as T,x as w,y as D,z as I,e as R,b as E,f as P,g as $,A as G,m as v}from"./index-BsOm2Fxm.js";import{A as K,M as O,a as _,S as Q}from"./AccountId-DYU0WSjI.js";function S({debt:s,borrower:a,onClose:t,open:c,rewards:d,rewardAssets:u}){const{data:m}=A(),{wallet:n}=k(),{accountId:r,processor:g,provider:p}=n||{},{data:h}=M(r),j=I(r),q=L(m,h),y=C.useMemo(()=>{const i={};return q&&m.forEach(({name:l})=>{const{price:o}=h[l];q.supplyAmount>s&&(i[l]=s/o)}),i},[s,q]);async function x(i,l){try{await g.liquidation(p,{amount:l,borrower:a,token:i}),setTimeout(async()=>{j(),w.invalidateQueries({queryKey:["liquidateData"]}),w.invalidateQueries({queryKey:["marketData"]}),w.invalidateQueries({queryKey:["userTokenData"]})},D)}catch(o){console.log("Unable to liquidate",o)}}const f=Object.entries(y).reduce((i,l)=>i+l,0);return e.jsx(T,{open:c,onClose:t,children:e.jsxs("div",{className:"liquidation-modal",children:[e.jsx("h3",{children:"Choose Asset to Liquidate"}),e.jsxs("div",{className:"wallets-container",children:[u.map((i,l)=>{const o=m.find(({name:b})=>b===i),N=y[o.name]||0;return N>0?e.jsxs("button",{onClick:()=>x(o,d[l]),style:{display:"flex",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",marginLeft:"5px"},children:[e.jsx("img",{src:o.icon,alt:o.name,style:{marginRight:"10px"}}),e.jsx("p",{children:o.name})]}),e.jsx("p",{children:Math.floor(N*1e3)/1e3})]},o.id):""}),f<=0&&e.jsx("p",{children:"You don't have enough assets supplied to liquidate this loan"})]})]})})}function V({amount:s,borrower:a,debt:t,reward:c,rewardAssets:d}){const u=R(),{data:m}=A(),n=c.map(r=>Math.floor(r*1e3)/1e3);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{padding:"20px 10px",marginBottom:0},children:[e.jsx("span",{className:"asset-cell",children:`$${Math.floor(t*1e3)/1e3}`}),e.jsx("div",{className:"cell",children:e.jsx("span",{title:a,children:e.jsx(K,{accountId:a})})}),e.jsx("div",{className:"cell",children:d.map((r,g)=>{const{icon:p,name:h}=m.find(j=>j.name===r)||{};return e.jsx("img",{src:p,alt:h},g)})}),e.jsx(O,{max:`${n.join(", ")}`,min:`$${Math.floor(s*1e3)/1e3}`}),e.jsx("div",{className:"cell",children:e.jsx(E,{className:"small",onClick:u.onRequestOpen,size:"small",type:"secondary-btn",children:"Liquidate"})})]}),e.jsx(S,{...u,borrower:a,debt:t,rewards:c,rewardAssets:d})]})}const B=async(s,a)=>{const t=a.getContract("MarketPositionManager",G);let c=[];const{borrowers:d,debts:u,reward:m}=await t.call("checkLiquidations");for(let n=0;n<d.length;n++){const r=d[n],g=u[n],p=m[n];if(!u[n])continue;const{suppliedAssets:h,liquidateAmounts:j}=await t.call("calcLiquidationDetails",r,p);let q=[],y=[];for(let x=0;x<h.length;x++){if(!j[x])continue;const f=s.find(({evmSfId:i})=>i===h[x]);q.push(f.name),y.push(new v(j[x]).div("1e18").toNumber())}c.push({borrower:r,debt:new v(g).div("1e18").toNumber(),rewardAssets:q,rewardAmounts:y,rewardValue:new v(p).div("1e18").toNumber()})}return c},U=s=>{const a=P(),{data:t}=A();return $({queryKey:["liquidateData",t],queryFn:()=>B(t,a),enabled:!!t.length,...s})};function z(){const{data:s,isPending:a}=U();return e.jsx("div",{className:"content-container liquidations-container",children:e.jsxs("div",{className:"liquidation-inner-container",children:[e.jsx("h3",{className:"liquidation-header",children:"Liquidations Manager"}),e.jsxs(_,{title:"Liquidation Markets",children:[a?e.jsx(Q,{}):s==null?void 0:s.map(t=>t.borrower&&t.rewardValue>0&&e.jsx(V,{amount:`${t.rewardValue}`,borrower:t.borrower,debt:t.debt,reward:t.rewardAmounts,rewardAssets:t.rewardAssets},t.borrower)),!a&&!(s!=null&&s.length)&&e.jsx("h3",{style:{margin:"10px 0 0 10px"},children:"There are no more liquidations."})]})]})})}function Y(){return e.jsx(z,{})}export{Y as default};
